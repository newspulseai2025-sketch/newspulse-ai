<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Commodities Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>
<style>
body { background-color:#F0F2F5; font-family:'Inter',sans-serif; padding-top:20px; }
.dashboard-card { background-color:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); padding:25px 35px; margin:0 auto; overflow-x:auto; }
.text-up { color:#10B981 !important; font-weight:600; }
.text-down { color:#EF4444 !important; font-weight:600; }
#indicatorTable { width:100% !important; font-size:0.80rem; }
.table-responsive { overflow-x:auto; }
#indicatorTable thead th { position:sticky; top:0; background-color:#f8f9fa; z-index:1; }
#indicatorTable thead th:first-child, #indicatorTable tbody td:first-child { position:sticky; left:0; background-color:#f8f9fa; z-index:2; }
</style>
</head>
<body>

<div class="container-fluid">
<div class="dashboard-card">
<h2>Commodities Dashboard</h2>

<div class="row mb-4 align-items-end">
    <div class="col-auto">
        <label for="commoditySelect" class="form-label">Commodity</label>
        <select id="commoditySelect" class="form-select form-select-sm">
            <option value="BZF">Brent Futures (BZF)</option>
            <option value="CLF">Crude Oil Futures (CLF)</option>
            <option value="NGF">Natural Gas Futures (NGF)</option>
            <option value="GCF">Gold Futures (GCF)</option>
            <option value="SIF">Silver Futures (SIF)</option>
            <option value="RBF">Gasoline Futures (RBF)</option>
            <option value="HOF">Heating Oil Futures (HOF)</option>
        </select>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary btn-sm px-4" onclick="loadIndicators()">Show Indicators</button>
    </div>
    <div class="col-auto">
        <button class="btn btn-success btn-sm px-4" onclick="loadSignal()">Show Signal</button>
    </div>
</div>

<h4 class="small fw-bold text-muted mt-3 mb-2">Indicators Data</h4>
<div class="table-responsive">
<table class="table table-hover display nowrap" id="indicatorTable">
    <thead>
        <tr>
            <th>Date</th><th>Coin</th><th>Open</th><th>High</th><th>Low</th><th>Close</th>
            <th>Volume</th><th>EMA_200</th><th>EMA_50</th><th>EMA_20</th>
            <th>RSI_14</th><th>ATR</th><th>ATR_pct</th><th>Vol_Ratio</th><th>MACD</th><th>MACD_signal</th><th>MACD_diff</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="17" class="text-center text-muted">Select a commodity and click "Show Indicators".</td></tr>
    </tbody>
</table>
</div>

<h4 class="small fw-bold text-muted mt-5 mb-2">Signal Analysis</h4>
<div id="signalBox" class="alert alert-info rounded-3">Select commodity and click "Show Signal".</div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = "http://127.0.0.1:8000";
let dataTable;

function formatPrice(v){ return '$' + Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }

async function loadIndicators(){
    const ticker = document.getElementById("commoditySelect").value;
    const tbody = $("#indicatorTable tbody");
    tbody.html('<tr><td colspan="17" class="text-center text-muted">Loading...</td></tr>');

    try{
        const res = await fetch(`${API_BASE}/commodities/indicators/${ticker}`);
        const data = await res.json();

        if($.fn.DataTable.isDataTable('#indicatorTable')) dataTable.destroy();
        tbody.html("");
        if(!data || data.length===0){ tbody.html('<tr><td colspan="17">No data</td></tr>'); return; }

        data.forEach(r=>{
            tbody.append(`<tr>
<td>${r.Date}</td>
<td>${r.Ticker}</td>
<td class="${r.Close>=r.Open?'text-up':'text-down'}">${formatPrice(r.Open)}</td>
<td class="text-up">${formatPrice(r.High)}</td>
<td class="text-down">${formatPrice(r.Low)}</td>
<td class="${r.Close>=r.Open?'text-up':'text-down'}">${formatPrice(r.Close)}</td>
<td>${Number(r.Volume).toLocaleString()}</td>
<td>${r.EMA_200}</td><td>${r.EMA_50}</td><td>${r.EMA_20}</td>
<td>${r.RSI_14}</td><td>${r.ATR}</td><td>${r.ATR_pct}</td>
<td>${r.Vol_Ratio}</td><td>${r.MACD}</td><td>${r.MACD_signal}</td><td>${r.MACD_diff}</td>
</tr>`);
        });

        dataTable = $('#indicatorTable').DataTable({"scrollY":"500px","scrollX":true,"paging":false,"order":[[0,"desc"]],"searching":false});
    }catch(e){
        tbody.html('<tr><td colspan="17">Error fetching data</td></tr>');
        console.error(e);
    }
}

async function loadSignal(){
    const ticker = document.getElementById("commoditySelect").value;
    const signalBox = document.getElementById("signalBox");
    signalBox.className='alert alert-info rounded-3'; signalBox.innerHTML="Loading signal...";

    try{
        const res = await fetch(`${API_BASE}/commodities/signal/${ticker}`);
        const data = await res.json();
        if(!data || data.length===0){ signalBox.innerHTML="No signal"; return; }

        const s = data[0];
        let cls = s.Signal.toUpperCase()==='BUY'?'alert-success':s.Signal.toUpperCase()==='SELL'?'alert-danger':'alert-warning';
        signalBox.className=`alert ${cls} rounded-3`;
        signalBox.innerHTML=`<b>Signal:</b> ${s.Signal}<br><b>Price:</b> ${formatPrice(s.Live_Price)}<br><b>Confidence:</b> ${s.Confidence}`;
    }catch(e){
        signalBox.className='alert alert-danger'; signalBox.innerHTML="Error fetching signal";
        console.error(e);
    }
}
</script>
</body>
</html>